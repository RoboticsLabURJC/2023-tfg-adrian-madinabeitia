---
title: "Semana 6 - PilotoExperto siguelineas"
categories:
  - Weekly Log
tags:
  - ROS2
  - Aerostack2
---



## Index
* [Solución de error de ruta del mundo](#solucion-de-error-de-ruta-del-mundo)
* [Problemas encontrados](#problemas-encontrados)

---
---

## Solucion de error de ruta del mundo
Como mencioné en semanas anteriores vi un fallo a la hora de cargar el mundo en gazebo, por lo que hice un  [pull request]() con el cambio, siendo mi primer pull request aceptado en un proyecto en el que no haya participado directamente.


---
---

## Problemas encontrados

### Tardanza en arranque
Para solucionar la tardanza producida por PX4, me puse de contacto de nuevo con el equipo de aerostack2 en el siguiente [issue](https://github.com/aerostack2/aerostack2/issues/351) donde gracias a los desarrolladores conseguí solucionar el fallo. 

Lo que se hizo principalmente fué cambiar las cordenadas del drone al origen del mapa y desactivar el parámetro de COM_DISARM_PRFLT.

---

### Drone no cambia de velocidad reactiamente
Cuando conseguí despegar el drone en un tiempo razonable, empecé con la implementación del sigue lineas, el problema es que los timers de ros no me funcionaban a la hora de comandar velocidades con el drone, pero conseguí hacerlo funcionar llamando constantemente a la función de un bucle, el problema es que si no se hace "descansar" el procesador, este se saturará y no publicará las imágenes a tiempo, la solución fué sencilla. Añadir un sleep.

También se capturó la interrupción de ctrl+c para que cuando esta se pulse, el drone aterrice y el programa se cierre adecuadamente.

---

### Sistema mas "nervioso" y consideración de la altura

El drone es un sistema mas nervioso que el coche por lo que lo primero que se hizo fué alinear el punto mas alto estimado de la linea con el centro, haciendo lo mismo con el mas bajo, dando al mas bajo igual o más importancia para que el robot siga satisfactoriamente la linea.

---

### Problema de la altura
El siguiente problema fué la altura, lo primero es que la linea se hace mas fina, con una dilatación de imagen no es suficiente ya que si el filtro de color falla, estos defectos se harán mas grandes por lo que se hizo una apertura. Primero se erosionó la imagen poco ya que una apertura excesiva eliminaria la parte proxima de la linea dejando al drone poco tiempo de reacción. La dilatación se hizo grande para poder tener una linea considerable. 

El drone tiene una vista mayor a la del coche por lo que puede ver más allá de sus siguientes pasos, esto puede producir que al seguir la linea detecte el rojo de otra curva y se vaya a ella. Si erosionamos mucho perderemos información y tiempo de respuesta por lo que mas ideal será usar algún metodo donde consigamos la distancia de la linea. 

---

### Overshoot en altura con configuración por defecto
Se aplica un PID al control normal de velocidad, ya que con los primero valores del pid se consiguió un buenresultado no cambié el de aerostack, pero se grabó un video de como funciona el control de velocidad de un drone sin PID.

---
---

## Midas
Midas es una red neuronal que a partir de imágenes de 2D infiere la imagen de profundidad.

### Conda
Para activar conda:

```bash
source ~/anaconda3/bin/activate
```
<!-- Hacer un fichero intermedio donde añadir la clase de PID y funciones que usan ambos nodos. Llamar contol_functions -->